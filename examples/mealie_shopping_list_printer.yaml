# Mealie Shopping List Printer Script for Home Assistant
#
# This script fetches a shopping list from Mealie via the Mealie Home Assistant
# integration, sends it to OpenAI for categorization by grocery store aisle,
# and prints the organized list to a thermal receipt printer.
#
# PREREQUISITES:
#   1. Mealie integration installed and configured (HACS)
#      - Creates todo.mealie_* entities for shopping lists
#   2. OpenAI Conversation integration configured in HA
#      - Set it as your DEFAULT conversation agent in Settings > Voice Assistants
#      - Or use rest_command approach shown in alternative below
#   3. This ESC/POS Thermal Printer integration installed and configured
#
# FINDING YOUR OPENAI AGENT ID (if not using default):
#   1. Go to Developer Tools > Services
#   2. Select "Conversation: Process"
#   3. Click the Agent dropdown - your OpenAI agent will show with its ID
#   4. The ID looks like: "01HXXXXXXXXXXXXXXXXXXXXXX" (not "conversation.openai")
#
# INSTALLATION:
#   1. Copy this file to your Home Assistant config directory
#   2. Add to configuration.yaml:
#      script: !include mealie_shopping_list_printer.yaml
#   3. Restart Home Assistant
#   4. Update the entity IDs to match your setup
#
# USAGE:
#   Call the script from automations, dashboard buttons, or voice assistants:
#   service: script.print_mealie_shopping_list

print_mealie_shopping_list:
  alias: "Print Mealie Shopping List"
  description: "Fetch Mealie shopping list, categorize with OpenAI, and print to receipt printer"
  icon: mdi:printer-pos
  mode: single

  # Input fields allow customization when calling the script
  fields:
    shopping_list_entity:
      name: Shopping List Entity
      description: "The Mealie todo entity to print"
      required: false
      default: "todo.mealie_shopping_list"
      selector:
        entity:
          domain: todo
    openai_agent_id:
      name: OpenAI Agent ID
      description: "OpenAI conversation agent ID (leave empty to use default assistant)"
      required: false
      example: "01HXXXXXXXXXXXXXXXXXXXXXX"
      selector:
        text:
    printer_device_id:
      name: Printer Device ID
      description: "Target printer device ID (optional - uses all printers if not specified)"
      required: false
      selector:
        device:
          integration: escpos_printer

  variables:
    # Default shopping list entity - change to match your Mealie entity
    list_entity: "{{ shopping_list_entity | default('todo.mealie_shopping_list') }}"

  sequence:
    # Step 1: Get all items from the Mealie shopping list
    - alias: "Fetch shopping list items from Mealie"
      service: todo.get_items
      target:
        entity_id: "{{ list_entity }}"
      data:
        status: needs_action
      response_variable: shopping_items

    # Step 2: Check if list is empty
    - alias: "Check for empty list"
      if:
        - condition: template
          value_template: "{{ shopping_items[list_entity]['items'] | length == 0 }}"
      then:
        - alias: "Print empty list message"
          service: escpos_printer.print_text_utf8
          data:
            text: |
              ================================
                   SHOPPING LIST EMPTY
              ================================

              No items on your shopping list!

              Add items in Mealie to print.
            align: center
            feed: 3
            cut: full
        - stop: "Shopping list is empty"

    # Step 3: Format items for OpenAI prompt
    - alias: "Prepare item list for OpenAI"
      variables:
        items_text: >-
          {% set items = shopping_items[list_entity]['items'] %}
          {% for item in items %}
          - {{ item.summary }}
          {% endfor %}
        item_count: "{{ shopping_items[list_entity]['items'] | length }}"

    # Step 4: Build the prompt for categorization
    - alias: "Build categorization prompt"
      variables:
        categorization_prompt: >-
          Categorize the following shopping list items by grocery store section.
          Return ONLY valid JSON with no markdown formatting, no code blocks, no explanation.

          Use this exact JSON structure:
          {"categories": [{"name": "Section Name", "items": ["item1", "item2"]}]}

          Use these category names when applicable:
          - Produce
          - Dairy & Eggs
          - Meat & Seafood
          - Bakery
          - Deli
          - Frozen
          - Pantry & Canned Goods
          - Snacks & Beverages
          - Condiments & Sauces
          - Household & Cleaning
          - Personal Care
          - Other

          Shopping list items:
          {{ items_text }}

    # Step 5: Send to OpenAI for categorization
    # Uses default conversation agent unless openai_agent_id is specified
    - alias: "Categorize items with OpenAI"
      choose:
        - conditions:
            - condition: template
              value_template: "{{ openai_agent_id is defined and openai_agent_id }}"
          sequence:
            - service: conversation.process
              data:
                agent_id: "{{ openai_agent_id }}"
                text: "{{ categorization_prompt }}"
              response_variable: ai_response
      default:
        - service: conversation.process
          data:
            text: "{{ categorization_prompt }}"
          response_variable: ai_response

    # Step 6: Parse AI response and format receipt
    - alias: "Parse categorized response"
      variables:
        # Extract JSON from the AI response
        parsed_response: >-
          {% set response_text = ai_response.response.speech.plain.speech %}
          {% set clean_text = response_text | regex_replace('```json\\s*', '') | regex_replace('```\\s*', '') | trim %}
          {{ clean_text | from_json }}

    # Step 7: Print the receipt header
    - alias: "Print receipt header"
      service: escpos_printer.print_text_utf8
      data:
        text: "SHOPPING LIST"
        align: center
        bold: true
        width: double
        height: double
        feed: 1
        device_id: "{{ printer_device_id | default(omit) }}"

    - alias: "Print timestamp"
      service: escpos_printer.print_text_utf8
      data:
        text: "{{ now().strftime('%B %d, %Y at %I:%M %p') }}"
        align: center
        feed: 1
        device_id: "{{ printer_device_id | default(omit) }}"

    - alias: "Print item count"
      service: escpos_printer.print_text_utf8
      data:
        text: "{{ item_count }} items"
        align: center
        feed: 1
        device_id: "{{ printer_device_id | default(omit) }}"

    - alias: "Print separator"
      service: escpos_printer.print_text_utf8
      data:
        text: "================================"
        align: center
        feed: 1
        device_id: "{{ printer_device_id | default(omit) }}"

    # Step 8: Print each category and its items
    - alias: "Print categorized items"
      repeat:
        for_each: "{{ parsed_response.categories }}"
        sequence:
          # Print category header
          - service: escpos_printer.print_text_utf8
            data:
              text: "{{ repeat.item.name | upper }}"
              align: left
              bold: true
              width: double
              feed: 0
              device_id: "{{ printer_device_id | default(omit) }}"

          - service: escpos_printer.print_text_utf8
            data:
              text: "--------------------------------"
              align: left
              feed: 0
              device_id: "{{ printer_device_id | default(omit) }}"

          # Print each item with checkbox
          - repeat:
              for_each: "{{ repeat.item.items }}"
              sequence:
                - service: escpos_printer.print_text_utf8
                  data:
                    text: "[ ] {{ repeat.item }}"
                    align: left
                    feed: 0
                    device_id: "{{ printer_device_id | default(omit) }}"

          # Add spacing after category
          - service: escpos_printer.feed
            data:
              lines: 1
              device_id: "{{ printer_device_id | default(omit) }}"

    # Step 9: Print footer and cut
    - alias: "Print footer"
      service: escpos_printer.print_text_utf8
      data:
        text: |
          ================================
               Happy Shopping!
          ================================
        align: center
        feed: 3
        cut: full
        device_id: "{{ printer_device_id | default(omit) }}"


# =============================================================================
# ALTERNATIVE VERSION: Using REST API for OpenAI
# =============================================================================
# Use this version if you prefer direct OpenAI API calls instead of the
# conversation integration. Requires rest_command configuration.
#
# Add to configuration.yaml:
#
# rest_command:
#   openai_categorize:
#     url: "https://api.openai.com/v1/chat/completions"
#     method: POST
#     headers:
#       Authorization: "Bearer {{ states('input_text.openai_api_key') }}"
#       Content-Type: "application/json"
#     payload: >-
#       {
#         "model": "gpt-4o-mini",
#         "temperature": 0.7,
#         "max_tokens": 1000,
#         "messages": [
#           {
#             "role": "system",
#             "content": "You categorize shopping lists by grocery store section. Return only valid JSON."
#           },
#           {
#             "role": "user",
#             "content": "{{ prompt }}"
#           }
#         ]
#       }
#     content_type: "application/json"

print_mealie_shopping_list_rest:
  alias: "Print Mealie Shopping List (REST API)"
  description: "Alternative version using direct OpenAI REST API"
  icon: mdi:printer-pos
  mode: single

  fields:
    shopping_list_entity:
      name: Shopping List Entity
      description: "The Mealie todo entity to print"
      required: false
      default: "todo.mealie_shopping_list"
      selector:
        entity:
          domain: todo

  variables:
    list_entity: "{{ shopping_list_entity | default('todo.mealie_shopping_list') }}"

  sequence:
    # Fetch shopping list
    - service: todo.get_items
      target:
        entity_id: "{{ list_entity }}"
      data:
        status: needs_action
      response_variable: shopping_items

    # Check for empty list
    - if:
        - condition: template
          value_template: "{{ shopping_items[list_entity]['items'] | length == 0 }}"
      then:
        - service: escpos_printer.print_text_utf8
          data:
            text: "Shopping list is empty!"
            align: center
            feed: 3
            cut: full
        - stop: "Empty list"

    # Prepare items
    - variables:
        items_for_api: >-
          {% set items = shopping_items[list_entity]['items'] %}
          {% set item_list = [] %}
          {% for item in items %}
            {% set item_list = item_list + [item.summary] %}
          {% endfor %}
          {{ item_list | join(', ') }}
        item_count: "{{ shopping_items[list_entity]['items'] | length }}"

    # Call OpenAI REST API
    - service: rest_command.openai_categorize
      data:
        prompt: >-
          Categorize these shopping items by grocery store section.
          Return ONLY JSON: {"categories": [{"name": "Section", "items": ["item1"]}]}
          Items: {{ items_for_api }}
      response_variable: openai_result

    # Parse response (the REST response structure differs)
    - variables:
        ai_content: "{{ (openai_result.content | from_json).choices[0].message.content }}"
        parsed_response: "{{ ai_content | from_json }}"

    # Print header
    - service: escpos_printer.print_text_utf8
      data:
        text: "SHOPPING LIST"
        align: center
        bold: true
        width: double
        height: double
        feed: 1

    - service: escpos_printer.print_text_utf8
      data:
        text: |
          {{ now().strftime('%B %d, %Y') }}
          {{ item_count }} items
          ================================
        align: center
        feed: 1

    # Print categories
    - repeat:
        for_each: "{{ parsed_response.categories }}"
        sequence:
          - service: escpos_printer.print_text_utf8
            data:
              text: |
                {{ repeat.item.name | upper }}
                --------------------------------
              bold: true
              feed: 0

          - repeat:
              for_each: "{{ repeat.item.items }}"
              sequence:
                - service: escpos_printer.print_text_utf8
                  data:
                    text: "[ ] {{ repeat.item }}"
                    feed: 0

          - service: escpos_printer.feed
            data:
              lines: 1

    # Footer
    - service: escpos_printer.print_text_utf8
      data:
        text: |
          ================================
               Happy Shopping!
        align: center
        feed: 3
        cut: full
